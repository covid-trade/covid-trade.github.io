(function(r){d3.cartogram=function(){function r(r,l){r=a(r);var f,h,p,g=t(r.transform),m=r.arcs.length,d=0,v=new Array(m);while(d<m){f=0,h=0,j=r.arcs[d].length,P=0,p=new Array(j);while(P<j)r.arcs[d][P][0]=f+=r.arcs[d][P][0],r.arcs[d][P][1]=h+=r.arcs[d][P][1],p[P]=u(g(r.arcs[d][P])),P++;v[d++]=p}var y=d3.geo.path().projection(null),M=i(v,{type:"GeometryCollection",geometries:l}).geometries.map((function(t){return{type:"Feature",id:t.id,properties:c.call(null,t,r),geometry:t}})),w=M.map(s),q=d3.sum(w);if(o<=0)return M;var b=0;while(b++<o){var j,P,A,C,F,G,I,L,O,S,k,x,z,E,B=M.map(y.area),D=d3.sum(B),H=0,J=0,K=M.map((function(r,t){var e=Math.abs(B[t]),n=+w[t],a=D*n/q,o=Math.sqrt(e/Math.PI),i=Math.sqrt(a/Math.PI)-o,u=Math.max(e,a)/Math.min(e,a);return H+=u,J++,{id:r.id,area:e,centroid:y.centroid(r),value:n,desired:a,radius:o,mass:i,sizeError:u}})),N=H/J,Q=1/(1+N);m=v.length,d=0;while(d<m){j=v[d].length,P=0;while(P<j){A=[0,0],C=K.length,F=0;while(F<C)G=K[F].centroid,I=K[F].mass,L=K[F].radius,O=L*L,S=v[d][P][0]-G[0],k=v[d][P][1]-G[1],x=S*S+k*k,z=Math.sqrt(x),E=z>L?I*L/z:I*(x/O)*(4-3*z/L),A[0]+=E*e(k,S),A[1]+=E*n(k,S),F++;v[d][P][0]+=A[0]*Q,v[d][P][1]+=A[1]*Q,P++}d++}if(N<=1)break}return{features:M,arcs:v}}var o=8,u=d3.geo.albers(),c=function(r){return{}},s=function(r){return 1};return r.path=d3.geo.path().projection(null),r.iterations=function(t){return arguments.length?(o=t,r):o},r.value=function(t){return arguments.length?(s=d3.functor(t),r):s},r.projection=function(t){return arguments.length?(u=t,r):u},r.feature=function(r,t){return{type:"Feature",id:t.id,properties:c.call(null,t,r),geometry:{type:t.type,coordinates:topojson.feature(r,t).geometry.coordinates}}},r.features=function(t,e){return e.map((function(e){return r.feature(t,e)}))},r.properties=function(t){return arguments.length?(c=d3.functor(t),r):c},r};var t=d3.cartogram.transformer=function(r){var t=r.scale[0],e=r.scale[1],n=r.translate[0],a=r.translate[1];function o(r){return[r[0]*t+n,r[1]*e+a]}return o.invert=function(r){return[(r[0]-n)/t,(r[1]-a)/e]},o};function e(r,t){var e=r/t;return t>0?1/Math.sqrt(1+e*e):-1/Math.sqrt(1+e*e)}function n(r,t){var e=r/t;return t>0?e/Math.sqrt(1+e*e):-e/Math.sqrt(1+e*e)}function a(r){return r instanceof Array?r.map(a):"string"===typeof r||"number"===typeof r?r:o(r)}function o(r){var t={};for(var e in r)t[e]=a(r[e]);return t}function i(r,t){function e(t,e){e.length&&e.pop();for(var n=r[t<0?~t:t],a=0,o=n.length;a<o;++a)e.push(n[a]);t<0&&u(e,o)}function n(r){for(var t=[],n=0,a=r.length;n<a;++n)e(r[n],t);return t}function a(r){return r.map(n)}function o(r){return r=Object.create(r),r.coordinates=i[r.type](r.arcs),r}var i={LineString:n,MultiLineString:a,Polygon:a,MultiPolygon:function(r){return r.map(a)}};return"GeometryCollection"===t.type?(t=Object.create(t),t.geometries=t.geometries.map(o),t):o(t)}function u(r,t){var e,n=r.length,a=n-t;while(a<--n)e=r[a],r[a++]=r[n],r[n]=e}})();